---
layout: default
title: 文章編輯器 - 包給力 Givespower.health
permalink: /post-editor.html
---
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page.title }}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ '/css/style.css' | relative_url }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <style>
        .post-editor-section { max-width: 900px; margin: 0 auto; }
        #outputMarkdown { font-family: monospace; font-size: 13px; min-height: 280px; }
        .field-hint { font-size: 0.875rem; color: #6c757d; }
    </style>
</head>
<body>
    {% include nav.html %}

    <header class="page-header" style="padding: 100px 0 60px;">
        <div class="container text-center">
            <h1 style="font-size: 42px; font-weight: bold; margin-bottom: 15px;">部落格文章編輯器</h1>
            <p class="lead" style="font-size: 18px;">填寫下方欄位後按「儲存文章」，會直接寫入專案並於下次建站後顯示於<a href="{{ '/blog.html' | relative_url }}">專業分享</a>。</p>
        </div>
    </header>

    <div class="container" style="padding: 40px 0 80px;">
        <div class="post-editor-section">
            <div class="row">
                <div class="col-12">
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="form-tab" data-toggle="tab" href="#form-panel" role="tab">表單編輯</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="import-tab" data-toggle="tab" href="#import-panel" role="tab">從現有文章載入</a>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="form-panel" role="tabpanel">
                            <form id="postForm" class="border rounded p-4 bg-light">
                                <div class="form-group">
                                    <label for="postTitle">標題 (title) *</label>
                                    <input type="text" class="form-control" id="postTitle" required placeholder="例：突破減重平台期的五大策略">
                                </div>
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label for="postDate">日期 (date) *</label>
                                        <input type="date" class="form-control" id="postDate" required>
                                        <small class="field-hint">格式 YYYY-MM-DD，檔名會用此日期</small>
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label for="postSlug">網址代稱 (slug) *</label>
                                        <input type="text" class="form-control" id="postSlug" required placeholder="例：plateau-strategies" pattern="[a-z0-9-]+" title="僅小寫英文、數字、連字號">
                                        <small class="field-hint">用於 permalink：/blog/<strong>slug</strong>.html 與檔名 <em>YYYY-MM-DD-<strong>slug</strong>.md</em></small>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="postImageFile">上傳文章主圖 (image)</label>
                                    <input type="file" class="form-control-file" id="postImageFile" accept="image/jpeg,image/png,image/gif,image/webp">
                                    <small class="field-hint">選填。會儲存為 <code>img/programs/blog_<em>slug</em>.jpg</code>（依副檔名）。最大 4MB。</small>
                                    <div id="imagePreview" class="mt-2" style="display: none;"><img id="imagePreviewImg" src="" alt="預覽" style="max-height: 120px; border-radius: 6px;"></div>
                                </div>
                                <div class="form-group">
                                    <label for="postExcerpt">摘要 (excerpt) *</label>
                                    <textarea class="form-control" id="postExcerpt" rows="2" required placeholder="列表頁與預覽顯示的簡短描述"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="postIgLink">Instagram 貼文連結 (ig_link)</label>
                                    <input type="url" class="form-control" id="postIgLink" placeholder="https://www.instagram.com/...">
                                    <small class="field-hint">選填，有則文章會顯示「查看 Instagram 貼文」</small>
                                </div>
                                <div class="form-group">
                                    <label for="postBody">內文 (Markdown) *</label>
                                    <textarea class="form-control" id="postBody" rows="12" required placeholder="支援 Markdown：## 標題、**粗體**、列表等"></textarea>
                                </div>
                                <div id="formAlert" class="alert mb-3" style="display: none;" role="alert"></div>
                                <div class="form-group mb-0">
                                    <button type="submit" class="btn btn-primary" id="btnSubmit">儲存文章</button>
                                    <button type="button" class="btn btn-outline-secondary ml-2" id="btnPreview">預覽 Markdown</button>
                                    <button type="button" class="btn btn-outline-secondary ml-2" id="btnReset">清空表單</button>
                                </div>
                            </form>
                        </div>

                        <div class="tab-pane fade" id="import-panel" role="tabpanel">
                            <div class="border rounded p-4 bg-light">
                                <label for="importMarkdown">貼上現有文章的完整 Markdown（含 front matter）</label>
                                <textarea class="form-control" id="importMarkdown" rows="10" placeholder="貼上 _posts/*.md 的內容後按「載入到表單」"></textarea>
                                <button type="button" class="btn btn-primary mt-2" id="btnImport">載入到表單</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4" id="outputSection" style="display: none;">
                <div class="col-12">
                    <h3 class="highlight">預覽 Markdown</h3>
                    <p class="field-hint">備用：可下載為 <code>_posts/YYYY-MM-DD-slug.md</code> 手動放入專案。</p>
                    <textarea class="form-control" id="outputMarkdown" readonly></textarea>
                    <div class="mt-2">
                        <button type="button" class="btn btn-outline-success" id="btnDownload"><i class="bi bi-download"></i> 下載 .md 檔</button>
                        <button type="button" class="btn btn-outline-primary ml-2" id="btnCopy">複製到剪貼簿</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% include footer.html %}

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
(function() {
    var form = document.getElementById('postForm');
    var outputSection = document.getElementById('outputSection');
    var outputMarkdown = document.getElementById('outputMarkdown');
    var formAlert = document.getElementById('formAlert');
    var btnSubmit = document.getElementById('btnSubmit');
    var postImageFile = document.getElementById('postImageFile');
    var imagePreview = document.getElementById('imagePreview');
    var imagePreviewImg = document.getElementById('imagePreviewImg');

    function escapeYaml(str) {
        if (!str || !str.trim()) return '';
        var s = String(str).trim();
        if (s.indexOf(':') >= 0 || s.indexOf('\n') >= 0 || s.indexOf('"') >= 0 || s.indexOf("'") >= 0)
            return '"' + s.replace(/\\/g, '\\\\').replace(/"/g, '\\"').replace(/\n/g, '\\n') + '"';
        return s;
    }

    function getSlug() {
        return document.getElementById('postSlug').value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '-').replace(/-+/g, '-') || 'post';
    }

    function buildMarkdown(includeImagePath) {
        var title = document.getElementById('postTitle').value.trim();
        var date = document.getElementById('postDate').value.trim();
        var slug = getSlug();
        var excerpt = document.getElementById('postExcerpt').value.trim();
        var igLink = document.getElementById('postIgLink').value.trim();
        var body = document.getElementById('postBody').value.trim();
        var lines = ['---', 'layout: post', 'title: ' + escapeYaml(title), 'date: ' + date];
        if (includeImagePath && postImageFile.files.length) {
            var ext = (postImageFile.files[0].name.split('.').pop() || 'jpg').toLowerCase();
            if (!/^(jpe?g|png|gif|webp)$/.test(ext)) ext = 'jpg';
            lines.push('image: /img/programs/blog_' + slug + '.' + ext);
        }
        lines.push('excerpt: ' + escapeYaml(excerpt), 'permalink: /blog/' + slug + '.html');
        if (igLink) lines.push('ig_link: ' + igLink);
        lines.push('---', '', body, '');
        return lines.join('\n');
    }

    function setToday() {
        var d = new Date();
        document.getElementById('postDate').value = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    }
    setToday();

    function showAlert(msg, isSuccess) {
        formAlert.textContent = msg;
        formAlert.className = 'alert mb-3 ' + (isSuccess ? 'alert-success' : 'alert-danger');
        formAlert.style.display = 'block';
    }
    function hideAlert() {
        formAlert.style.display = 'none';
    }

    function readFileAsBase64(file) {
        return new Promise(function(resolve, reject) {
            var fr = new FileReader();
            fr.onload = function() {
                var data = fr.result;
                if (data.indexOf('base64,') >= 0) data = data.split('base64,')[1];
                resolve(data);
            };
            fr.onerror = reject;
            fr.readAsDataURL(file);
        });
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        hideAlert();
        var title = document.getElementById('postTitle').value.trim();
        var date = document.getElementById('postDate').value.trim();
        var slug = getSlug();
        var excerpt = document.getElementById('postExcerpt').value.trim();
        var content = document.getElementById('postBody').value.trim();
        var igLink = document.getElementById('postIgLink').value.trim();
        if (!title || !date || !slug || !excerpt || !content) {
            showAlert('請填寫所有必填欄位。', false);
            return;
        }
        var payload = {
            title: title,
            date: date,
            slug: slug,
            excerpt: excerpt,
            content: content,
            ig_link: igLink || undefined
        };
        var file = postImageFile.files[0];
        if (file) {
            if (file.size > 4 * 1024 * 1024) {
                showAlert('圖片不得超過 4MB。', false);
                return;
            }
            readFileAsBase64(file).then(function(base64) {
                var ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
                if (!/^(jpe?g|png|gif|webp)$/.test(ext)) ext = 'jpg';
                payload.image = { data: base64, extension: ext };
                doSave(payload);
            }).catch(function() {
                showAlert('無法讀取圖片，請重試。', false);
            });
        } else {
            doSave(payload);
        }
    });

    function doSave(payload) {
        btnSubmit.disabled = true;
        btnSubmit.textContent = '儲存中…';
        fetch('/api/save-post', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(function(res) {
            return res.text().then(function(text) {
                var data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    if (text.trim().indexOf('<!') === 0 || text.trim().indexOf('<') === 0) {
                        showAlert('目前開啟的網址沒有提供 API。請用「vercel dev」啟動後，在 http://localhost:3000/post-editor.html 開啟本頁再試。（若用 jekyll serve 或 localhost:4001，儲存功能無法使用）', false);
                        return;
                    }
                    showAlert('伺服器回傳格式錯誤，請稍後再試。', false);
                    return;
                }
                if (res.ok) {
                    formAlert.className = 'alert alert-success mb-3';
                    formAlert.innerHTML = (data.message || '文章已儲存至 GitHub。')
                        + ' 本地預覽：請在專案目錄執行 <code>git pull</code> 取得新文章，vercel dev 會自動重建後即可在 <a href="/blog.html">專業分享</a> 看到。'
                        + ' 正式站：推送後 Vercel 會自動建站。';
                    formAlert.style.display = 'block';
                } else {
                    showAlert(data.error || '儲存失敗，請稍後再試。', false);
                }
            });
        }).catch(function(err) {
            showAlert('連線錯誤：' + (err.message || '請確認已用 vercel dev 在 localhost:3000 開啟本頁。'), false);
        }).finally(function() {
            btnSubmit.disabled = false;
            btnSubmit.textContent = '儲存文章';
        });
    }

    document.getElementById('btnPreview').addEventListener('click', function() {
        outputMarkdown.value = buildMarkdown(true);
        outputSection.style.display = 'block';
        outputSection.scrollIntoView({ behavior: 'smooth' });
    });

    document.getElementById('btnReset').addEventListener('click', function() {
        form.reset();
        setToday();
        postImageFile.value = '';
        imagePreview.style.display = 'none';
        imagePreviewImg.src = '';
        outputSection.style.display = 'none';
        outputMarkdown.value = '';
        hideAlert();
    });

    document.getElementById('btnDownload').addEventListener('click', function() {
        var date = document.getElementById('postDate').value.trim();
        var slug = getSlug();
        var filename = (date || 'YYYY-MM-DD') + '-' + slug + '.md';
        var blob = new Blob([outputMarkdown.value], { type: 'text/markdown;charset=utf-8' });
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
    });

    document.getElementById('btnCopy').addEventListener('click', function() {
        outputMarkdown.select();
        document.execCommand('copy');
        var btn = this;
        var orig = btn.textContent;
        btn.textContent = '已複製！';
        setTimeout(function() { btn.textContent = orig; }, 2000);
    });

    postImageFile.addEventListener('change', function() {
        var file = this.files[0];
        if (!file) {
            imagePreview.style.display = 'none';
            imagePreviewImg.src = '';
            return;
        }
        var url = URL.createObjectURL(file);
        imagePreviewImg.src = url;
        imagePreview.style.display = 'block';
    });

    document.getElementById('btnImport').addEventListener('click', function() {
        var raw = document.getElementById('importMarkdown').value;
        var match = raw.match(/^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/);
        if (!match) {
            alert('無法解析：請貼上包含 --- ... --- 的完整文章內容。');
            return;
        }
        var fm = match[1];
        var body = match[2].trim();
        function getFm(key) {
            var re = new RegExp('^' + key + ':\\s*(.+)$', 'm');
            var m = fm.match(re);
            return m ? m[1].trim().replace(/^["']|["']$/g, '') : '';
        }
        document.getElementById('postTitle').value = getFm('title') || '';
        document.getElementById('postDate').value = (getFm('date') || '').slice(0, 10);
        var permalink = getFm('permalink') || '';
        var slugMatch = permalink.match(/\/blog\/(.+)\.html$/);
        document.getElementById('postSlug').value = slugMatch ? slugMatch[1] : '';
        document.getElementById('postExcerpt').value = getFm('excerpt') || '';
        document.getElementById('postIgLink').value = getFm('ig_link') || '';
        document.getElementById('postBody').value = body;
        postImageFile.value = '';
        imagePreview.style.display = 'none';
        document.getElementById('form-tab').click();
    });
})();
    </script>
</body>
</html>
